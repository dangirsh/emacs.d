#!/usr/bin/env bash
# -*- mode: sh; -*-

# File: mailfetcher
# Time-stamp: <2016-09-08 07:56:49>
# Copyright (C) 2016 Pierre Lecocq
# Description:

# Check internet connection
echo -e "GET http://google.com HTTP/1.0\n\n" | nc google.com 80 > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Not connected to the internetz."
    exit 1
fi

mkdir -p ~/.mail/{gmail,qsdfgh}

# Remove deleted emails from disk
notmuch search --output=files tag:deleted | xargs rm

# Fetch emails from all imap accounts
mbsync -a

# Insert in notmuch DB
notmuch new

# Add tags
notmuch tag -inbox +gmail to:blabla1@gmail.com tag:inbox
notmuch tag -inbox +qsdfgh to:blabla2@gmail.com tag:inbox

# Notification
res=$(notmuch count tag:unread tag:inbox)
if [ $res != "0" ]; then
    arch=`uname`

    if [ $arch = "Darwin" ]; then
        terminal-notifier -title "MailFetcher" -message "$res unread messages"
    elif [ $arch = "Linux" ]; then
        notify-send "$res unread messages"
    else
        echo "$res unread messages"
    fi
fi
